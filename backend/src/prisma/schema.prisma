generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  LIVREUR
  RESTAURANT
  ADMIN
}

enum AccountStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  UNSUSPEND
  CHANGES_REQUIRED
  PROFILE_EDIT
}

enum DietaryRestriction {
  NO_RESTRICTIONS
  VEGETARIAN
  VEGAN
  GLUTEN_FREE
  DAIRY_FREE
  NUT_FREE
  HALAL
}

enum CuisinePreference {
  ITALIAN
  JAPANESE
  HEALTHY
  BURGERS
  BAKERY
  CAFE
  SANDWICHES
  VEGAN
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  passwordHash  String
  role          Role
  status        AccountStatus @default(PENDING)

  emailVerifiedAt            DateTime?
  emailVerificationTokenHash String?
  emailVerificationExpiresAt DateTime?

  statusReason String?
  suspendedAt  DateTime?

  passwordResetTokenHash     String?
  passwordResetTokenExpiresAt DateTime?

  // Relations for Order (client)
  clientOrders   Order[]      @relation("ClientOrders")
  // Relations for Order (restaurant)
  restaurantOrders Order[]    @relation("RestaurantOrders")
  
  accountHistory AccountHistory[]  

  // Role-specific profiles (1-1)
  clientProfile ClientProfile?
  restaurantProfile RestaurantProfile?
  livreurProfile LivreurProfile?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([status])
}

model ClientProfile {
  id               String @id @default(cuid())
  userId           String @unique
  user             User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Client profile fields (mandatory after signup step 2)
  fullName         String?
  phone            String?
  defaultAddress   String?

  notificationPreferences Json? @default("{}")

  cuisinePreferences  CuisinePreference[]
  dietaryRestrictions DietaryRestriction[]

  termsAcceptedAt   DateTime?

  submittedAt         DateTime?
  joinedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EstablishmentType {
  FAST_FOOD
  CAFE
  BAKERY
  RESTAURANT
  HOTEL
}

enum OwnershipType {
  OWNER
  MANAGER
}

enum PayoutMethod {
  BANK_TRANSFER
  MOBILE_WALLET
  CASH
  OTHER
}

model RestaurantProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Step 2 - Identity
  restaurantName      String?
  establishmentType   EstablishmentType?
  phone               String?
  address             String?
  city                String?
  logoUrl            String?
  coverImageUrl       String?

  // Step 3 - Legal
  legalEntityName                   String?
  registrationNumberRNE             String?
  ownershipType                     OwnershipType?
  businessRegistrationDocumentUrl   String?
  hygieneCertificateUrl             String?
  proofOfOwnershipOrLeaseUrl        String?

  // Step 4 - Payout (optional)
  payoutMethod   PayoutMethod?
  payoutDetails  Json?
  
  // Step 5 - terms acceptance
  termsAcceptedAt     DateTime?
  termsAcceptedName   String?   

  // Onboarding progress
  identityCompletedAt DateTime?
  legalCompletedAt    DateTime?
  payoutCompletedAt   DateTime?

  submittedAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum AccountAction {
  SUSPEND
  UNSUSPEND
  APPROVE
  REJECT
  REQUIRE_CHANGES
  PROFILE_EDIT
}

model AccountHistory {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  actorId     String        // Who did the action (admin or user)
  actorRole   String        // "ADMIN" | "USER"
  action      AccountAction
  field       String?       // For PROFILE_EDIT, what field changed
  oldValue    String?       // For PROFILE_EDIT only
  newValue    String?       // For PROFILE_EDIT only
  reason      String?       // For SUSPEND, REJECT, REQUIRE_CHANGES
  createdAt   DateTime      @default(now())
}

model LivreurProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal info
  fullName      String?
  phone         String?
  vehicleType   String?    // "car", "bike", etc.
  zone          String?    // Delivery zone/city
  photoUrl      String?

  // Legal documents
  cinOrPassportNumber String?
  licensePhotoUrl     String?
  vehicleOwnershipDocUrl String? 
  vehiclePhotoUrl        String? 

  // Banking info (optional at onboarding)
  payoutMethod   PayoutMethod?
  payoutDetails  Json?

  // Platform fields
  termsAcceptedAt     DateTime?
  termsAcceptedName   String?

  submittedAt         DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Order {
  id           String      @id @default(uuid())
  clientId     String
  client       User        @relation("ClientOrders", fields: [clientId], references: [id])
  restaurantId String
  restaurant   User        @relation("RestaurantOrders", fields: [restaurantId], references: [id])
  items        Json        // or a separate OrderItem model for high flexibility
  total        Float
  status       OrderStatus @default(PENDING)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Add more as needed (livreurId, deliveryAddress, etc.)
}

// Example enum for order status
enum OrderStatus {
  PENDING
  CONFIRMED
  READY
  PICKED_UP
  DELIVERED
  CANCELLED
}